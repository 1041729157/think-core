<case value="audio_oss">
    <div class="form-group item_{$form.name} {$form.extra_class}">
        <label class="left control-label">{$[type]form.title}：</label>
        <div class="right">
            <div id="{$gid}" <empty name='form.extra_attr'>data-url="{:U('/api/OssUpload/policyGet', array('type' => 'audio'))}"<else/>{$form.extra_attr}</empty>>
                <a id="{$gid}_selectfiles" class='uploadify-button btn btn-primary pure-button button-more button-xsmall' href="javascript:void(0);">上传文件</a>
                <div class="uploadify-queue">
                </div>
            </div>
            <div id="{$gid}_preview">
                <input type="hidden" name="{$form.name}" value="{$form.value}">
                <notempty name="form.value">
                    <span class="img-box" >
                        <div style="width:50%">
                        <audio src="{$form.value|showFileUrl}" class="audio_oss" controls preload="none"  >
                            您的浏览器不支持 audio 标签。
                        </audio>      
                         <i class="fa fa-times-circle remove-picture"></i>    
                        </div>    
                       
                    </span>
                </notempty>
            </div>
            <notempty name="form.tip">
                <span class="check-tips small">{$form.tip}</span>
            </notempty>
            <notdefined name="audio_oss">
                <link rel="stylesheet" href="{:asset('libs/audioplayer/audioplayer.css')}" />
                
                <script type="text/javascript" src="__PUBLIC__/libs/plupload-2.1.2/js/plupload.full.min.js"></script>
                <script type="text/javascript" src="__PUBLIC__/static/oss_upload.js"></script>
<!--                 <script src="{:asset('libs/audiojs/audio.min.js')}"></script>-->
                <script src="{:asset('libs/audioplayer/audioplayer.js')}"></script>                 
                <define name="audio_oss" value="1" />
            </notdefined>
            <script type="text/javascript">
                $( '.audio_oss' ).audioPlayer();
                new plupload.Uploader({
                    runtimes : 'html5,flash,silverlight,html4',
                    browse_button : '{$gid}_selectfiles',
                    multi_selection: false,
                    container: document.getElementById('{$gid}'),
                    flash_swf_url : '__PUBLIC__/libs/plupload-2.1.2/js/Moxie.swf',
                    silverlight_xap_url : '__PUBLIC__/libs/plupload-2.1.2/js/Moxie.xap',
                    url : 'http://oss.aliyuncs.com',

                    filters: {
                        mime_types : [ //只允许上传音频
                        { title : "Image files", extensions : "mp3,wav,cd,ogg,wma,asf,rm,real,ape,midi,m4a" },
                        ],
                        prevent_duplicates : true //不允许选取重复文件
                    },

                    init: {
                        PostInit: function() {
                            $('#{$gid}').children('.uploadify-queue').html('');
                              
                        },

                        FilesAdded: function(up, files) {
                            $('.img-box').remove();
                            plupload.each(files, function(file) {
                             
                                var html = '<div id="' + file.id + '" class="uploadify-queue-item">' +
                                        '<div class="uploadify-progress" lastloaded="0">' +
                                        '<div class="uploadify-progress-bar" style="width: 0%;">' +
                                        '</div>' +
                                        '</div>' +
                                        '<span class="up_percent">0%</span>' +
                                        '<span class="up_filename">' + file.name + '</span>' +
                                        '<i class="fa fa-times-circle remove-picture"></i>'+
                                        '</div>';
                                $('#{$gid}').children('.uploadify-queue').html(html);
                                set_upload_param(up, file.name, false, $('#{$gid}').data('url'));
                            });

                        },

                        UploadProgress: function(up, file) {
                            $('#' + file.id).children('.uploadify-progress').attr('lastloaded', file.loaded);
                            $('#' + file.id).find('.uploadify-progress-bar').css('width', file.percent + "%");
                            $('#' + file.id).children('.up_percent').html(file.percent + "%");
                        },

                        FileUploaded: function(up, file, info) {

                            if (info.status == 200)
                            {
                                var response = JSON.parse(info.response);
                                $('#{$gid}_preview').html('');
                                $('#{$gid}_preview').append('<input type="hidden" name="{$form.name}" value="' + response.file_id + '">');

                                $('#{$gid}_preview').append('<span class="img-box"><div style = "width:50%;" ><audio  controls preload="none" class = "audio_oss"  src="' + response.file_url + '"   >您的浏览器不支持 audio 标签。</audio><i class="fa fa-times-circle remove-picture"></i></div></span>');
                                $( '.audio_oss' ).audioPlayer();
                                 
                            }
                            else
                            {
                                alert(info.response);
                            }
                            $('#{$gid}').children('.uploadify-queue').empty();
                        },

                        Error: function(up, err) {
                            if (err.code == -600) {
                                alert("选择的文件太大了,可以根据应用情况，在upload.js 设置一下上传的最大大小");
                            }
                            else if (err.code == -601) {
                                alert("选择的文件后缀不对,可以根据应用情况，在upload.js进行设置可允许的上传文件类型");
                            }
                            else if (err.code == -602) {
                                alert("这个文件已经上传过一遍了");
                            }
                            else
                            {
                                alert(err.response);
                            }
                        }
                    }
                }).init();
                
                //删除
                $('#{$gid}_preview').on('click','.remove-picture', function(){
                    $('#{$gid}_preview input').val('') //删除后覆盖原input的值为空
                    $(this).closest('.img-box').remove(); //删除                
                });
                //上传中删除
                $('#{$gid}').on('click','.remove-picture', function(){
                    $('#{$gid}_preview input').val(''); //删除后覆盖原input的值为空
                    $(this).parent().parent().remove();
                });                
            </script>
        </div>
    </div>
</case>